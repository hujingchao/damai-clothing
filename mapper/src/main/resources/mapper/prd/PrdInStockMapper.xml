<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fenglei.mapper.prd.PrdInStockMapper">

    <select id="wxPage" resultType="com.fenglei.model.prd.vo.PrdInStockItemVo">
        select ppis.id as inStockId,
        ppis.no as inStockNo,
        ppis.receive_id,
        ppis.receiver,
        ppis.receive_time,
        ppis.remark,
        ppis.bill_status,
        ppisi.id as inStockItemId,
        ppisi.set_top,
        ppisi.product_id,
        ppisi.main_pic_id,
        sf.url as mainPic,
        bm.name as productName,
        bm.number as productNum,
        ppisi.ticket_item_id,
        ppisi.ticket_no,
        ppisi.in_stock_num
        from prd_in_stock_item ppisi
        left join prd_in_stock ppis on ppisi.pid = ppis.id
        left join bd_material bm on bm.id = ppisi.product_id
        left join sys_files sf on sf.id = ppisi.main_pic_id
        <where>

            <if test="itemVo.keyWord !=null and itemVo.keyWord.trim() !=''.toString()">
                and ( ppis.no like concat ('%', #{itemVo.keyWord}, '%')
                or
                ppis.receiver like concat ('%', #{itemVo.keyWord}, '%')
                )
            </if>
            <if test="itemVo.inStockNo !=null and itemVo.inStockNo.trim() !=''.toString()">
                and ppis.no like  concat('%', #{itemVo.inStockNo }, '%')
            </if>
            <if test="itemVo.receiveTime !=null and itemVo.receiveTime.trim() !=''.toString()">
                and date_format(ppis.receive_time, '%Y-%m-%d') = #{ itemVo.receiveTime}
            </if>
            <if test="itemVo.receiveId !=null and itemVo.receiveId.trim() !=''.toString()">
                and ppis.receive_id = #{itemVo.receiveId }
            </if>
            <if test="itemVo.billStatus !=null and itemVo.billStatus !='4'.toString() ">
                and ppis.bill_status = #{itemVo.billStatus}
            </if>
            <if test="itemVo.ticketNo !=null and itemVo.ticketNo.trim() !=''.toString()">
                and ppisi.ticket_no like  concat('%', #{itemVo.ticketNo}, '%')
            </if>
            <if test="itemVo.productName !=null and itemVo.productName.trim() !=''.toString()">
                and bm.name like  concat('%', #{itemVo.productName}, '%')
            </if>
            <if test="itemVo.beginDate != null and itemVo.beginDate.trim() != ''">
                and date_format(ppis.receive_time, '%Y-%m-%d') &gt;= #{itemVo.beginDate}
            </if>
            <if test="itemVo.endDate != null and itemVo.endDate.trim() != ''">
                and date_format(ppis.receive_time, '%Y-%m-%d') &lt;= #{itemVo.endDate}
            </if>
        </where>
        order by ppisi.set_top desc
    </select>

    <resultMap id="itemDetailMap" type="com.fenglei.model.prd.entity.PrdInStock">
        <collection property="itemList" select="selectItem" column="{itemId=itemId}"
                    javaType="java.util.ArrayList" ofType="com.fenglei.model.prd.entity.PrdInStockItem">
        </collection>
    </resultMap>

    <select id="itemDetail" resultMap="itemDetailMap">
        select #{itemId} as itemId,
               ppis.*,
               su.username   as creator
        from prd_in_stock ppis
                 left join sys_user su on su.id = ppis.creator_id
        where ppis.id = #{id}
    </select>

    <select id="selectItem"  resultType="com.fenglei.model.prd.entity.PrdInStockItem">
        select ppisi.*, pct.color_id, pct.color, pct.specification, bm.name as productName, bm.number as productNum,sf.url as mainPic
        from prd_in_stock_item ppisi
                 left join prd_cutting_ticket_item pcti on pcti.id = ppisi.ticket_item_id
                 left join prd_cutting_ticket pct on pct.id = pcti.pid
                 left join bd_material bm on bm.id = ppisi.product_id
                 left join sys_files as sf on ppisi.main_pic_id = sf.id
        where ppisi.id = #{itemId}
    </select>



</mapper>
