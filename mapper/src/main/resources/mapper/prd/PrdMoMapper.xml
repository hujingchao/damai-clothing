<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fenglei.mapper.prd.PrdMoMapper">

    <select id="getPage" resultType="com.fenglei.model.prd.entity.PrdMo">
        SELECT pm.*
             , lkpm.no as prd_mo_link_no
             , bm.number as product_num, bm.name as product_name
             , bu.name as unit_name
             , ldr.username as leader, flr.username as follower
             , ctr.username as creator, utr.username as updater, atr.username as auditor
        FROM prd_mo pm
            LEFT JOIN prd_mo lkpm ON pm.prd_mo_link_id = lkpm.id
            LEFT JOIN bd_material bm ON pm.product_id = bm.id
            LEFT JOIN bd_unit bu ON bm.unit_id = bu.id
            LEFT JOIN sys_user ldr ON pm.leader_id = ldr.id
            LEFT JOIN sys_user flr ON pm.follower_id = flr.id
            LEFT JOIN sys_user ctr ON pm.creator_id = ctr.id
            LEFT JOIN sys_user utr ON pm.updater_id = utr.id
            LEFT JOIN sys_user atr ON pm.auditor_id = atr.id
        <where>
            <if test="prdMo.closeStatus != null">
                and pm.close_status = #{ prdMo.closeStatus }
            </if>
            <if test="prdMo.no != null and prdMo.no != ''">
                and pm.no like concat('%', #{ prdMo.no }, '%')
            </if>
            <if test="prdMo.productId != null and prdMo.productId != ''">
                and pm.product_id = #{ prdMo.productId }
            </if>
            <if test="prdMo.productIds != null and prdMo.productIds.size > 0">
                and pm.product_id in
                <foreach collection="prdMo.productIds" item="productId" index="index"
                         open="(" separator="," close=")">
                    #{ productId }
                </foreach>
            </if>
            <if test="prdMo.followerId != null and prdMo.followerId != ''">
                and pm.follower_id = #{ prdMo.followerId }
            </if>
            <if test="prdMo.followerIds != null and prdMo.followerIds.size > 0">
                and pm.follower_id in
                <foreach collection="prdMo.followerIds" item="followerId" index="index"
                         open="(" separator="," close=")">
                    #{ followerId }
                </foreach>
            </if>
            <if test="prdMo.productionStatus != null">
                and pm.production_status = #{ prdMo.productionStatus }
            </if>
            <if test="prdMo.inProductionStatus != null and prdMo.inProductionStatus.size > 0">
                and pm.production_status in
                <foreach collection="prdMo.inProductionStatus" item="productionStatus" index="index"
                         open="(" separator="," close=")">
                    #{ productionStatus }
                </foreach>
            </if>
            <if test="prdMo.billType != null and prdMo.billType != ''">
                and pm.bill_type = #{ prdMo.billType }
            </if>
            <if test="prdMo.billTypes != null and prdMo.billTypes.size > 0">
                and pm.bill_type in
                <foreach collection="prdMo.billTypes" item="billType" index="index"
                         open="(" separator="," close=")">
                    #{ billType }
                </foreach>
            </if>
            <if test="prdMo.deliveryDateBegin != null and prdMo.deliveryDateBegin != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &gt;= #{ prdMo.deliveryDateBegin }
            </if>
            <if test="prdMo.deliveryDateEnd != null and prdMo.deliveryDateEnd != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &lt;= #{ prdMo.deliveryDateEnd }
            </if>
            <if test="prdMo.preBeginDateBegin != null and prdMo.preBeginDateBegin != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &gt;= #{ prdMo.preBeginDateBegin }
            </if>
            <if test="prdMo.preBeginDateEnd != null and prdMo.preBeginDateEnd != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &lt;= #{ prdMo.preBeginDateEnd }
            </if>
            <if test="prdMo.preEndDateBegin != null and prdMo.preEndDateBegin != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &gt;= #{ prdMo.preEndDateBegin }
            </if>
            <if test="prdMo.preEndDateEnd != null and prdMo.preEndDateEnd != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &lt;= #{ prdMo.preEndDateEnd }
            </if>
            <if test="prdMo.auditTimeBegin != null and prdMo.auditTimeBegin != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &gt;= #{ prdMo.auditTimeBegin }
            </if>
            <if test="prdMo.auditTimeEnd != null and prdMo.auditTimeEnd != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &lt;= #{ prdMo.auditTimeEnd }
            </if>
        </where>
        ORDER BY pm.top ASC,pm.create_time DESC
    </select>

    <select id="getList" resultType="com.fenglei.model.prd.entity.PrdMo">
        SELECT pm.*
             , lkpm.no as prd_mo_link_no
             , bm.number as product_num, bm.name as product_name
             , bu.name as unit_name
             , ldr.username as leader, flr.username as follower
             , ctr.username as creator, utr.username as updater, atr.username as auditor
        FROM prd_mo pm
            LEFT JOIN prd_mo lkpm ON pm.prd_mo_link_id = lkpm.id
            LEFT JOIN bd_material bm ON pm.product_id = bm.id
            LEFT JOIN bd_unit bu ON bm.unit_id = bu.id
            LEFT JOIN sys_user ldr ON pm.leader_id = ldr.id
            LEFT JOIN sys_user flr ON pm.follower_id = flr.id
            LEFT JOIN sys_user ctr ON pm.creator_id = ctr.id
            LEFT JOIN sys_user utr ON pm.updater_id = utr.id
            LEFT JOIN sys_user atr ON pm.auditor_id = atr.id
        <where>
            1 = 1
            <if test="prdMo.no != null and prdMo.no != ''">
                and pm.no like concat('%', #{ prdMo.no }, '%')
            </if>
            <if test="prdMo.productId != null and prdMo.productId != ''">
                and pm.product_id = #{ prdMo.productId }
            </if>
            <if test="prdMo.productIds != null and prdMo.productIds.size > 0">
                and pm.product_id in
                <foreach collection="prdMo.productIds" item="productId" index="index"
                         open="(" separator="," close=")">
                    #{ productId }
                </foreach>
            </if>
            <if test="prdMo.followerId != null and prdMo.followerId != ''">
                and pm.follower_id = #{ prdMo.followerId }
            </if>
            <if test="prdMo.followerIds != null and prdMo.followerIds.size > 0">
                and pm.follower_id in
                <foreach collection="prdMo.followerIds" item="followerId" index="index"
                         open="(" separator="," close=")">
                    #{ followerId }
                </foreach>
            </if>
            <if test="prdMo.productionStatus != null">
                and pm.production_status = #{ prdMo.productionStatus }
            </if>
            <if test="prdMo.inProductionStatus != null and prdMo.inProductionStatus.size > 0">
                and pm.production_status in
                <foreach collection="prdMo.inProductionStatus" item="productionStatus" index="index"
                         open="(" separator="," close=")">
                    #{ productionStatus }
                </foreach>
            </if>
            <if test="prdMo.billType != null and prdMo.billType != ''">
                and pm.bill_type = #{ prdMo.billType }
            </if>
            <if test="prdMo.billTypes != null and prdMo.billTypes.size > 0">
                and pm.bill_type in
                <foreach collection="prdMo.billTypes" item="billType" index="index"
                         open="(" separator="," close=")">
                    #{ billType }
                </foreach>
            </if>
            <if test="prdMo.deliveryDateBegin != null and prdMo.deliveryDateBegin != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &gt;= #{ prdMo.deliveryDateBegin }
            </if>
            <if test="prdMo.deliveryDateEnd != null and prdMo.deliveryDateEnd != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &lt;= #{ prdMo.deliveryDateEnd }
            </if>
            <if test="prdMo.preBeginDateBegin != null and prdMo.preBeginDateBegin != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &gt;= #{ prdMo.preBeginDateBegin }
            </if>
            <if test="prdMo.preBeginDateEnd != null and prdMo.preBeginDateEnd != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &lt;= #{ prdMo.preBeginDateEnd }
            </if>
            <if test="prdMo.preEndDateBegin != null and prdMo.preEndDateBegin != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &gt;= #{ prdMo.preEndDateBegin }
            </if>
            <if test="prdMo.preEndDateEnd != null and prdMo.preEndDateEnd != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &lt;= #{ prdMo.preEndDateEnd }
            </if>
            <if test="prdMo.auditTimeBegin != null and prdMo.auditTimeBegin != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &gt;= #{ prdMo.auditTimeBegin }
            </if>
            <if test="prdMo.auditTimeEnd != null and prdMo.auditTimeEnd != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &lt;= #{ prdMo.auditTimeEnd }
            </if>
        </where>
        ORDER BY pm.create_time DESC
    </select>

    <select id="infoById" resultType="com.fenglei.model.prd.entity.PrdMo">
        SELECT pm.*
             , lkpm.no as prd_mo_link_no
             , bm.number as product_num, bm.name as product_name
             , bu.name as unit_name
             , ldr.username as leader, flr.username as follower
             , ctr.username as creator, utr.username as updater, atr.username as auditor
        FROM prd_mo pm
            LEFT JOIN prd_mo lkpm ON pm.prd_mo_link_id = lkpm.id
            LEFT JOIN bd_material bm ON pm.product_id = bm.id
            LEFT JOIN bd_unit bu ON bm.unit_id = bu.id
            LEFT JOIN sys_user ldr ON pm.leader_id = ldr.id
            LEFT JOIN sys_user flr ON pm.follower_id = flr.id
            LEFT JOIN sys_user ctr ON pm.creator_id = ctr.id
            LEFT JOIN sys_user utr ON pm.updater_id = utr.id
            LEFT JOIN sys_user atr ON pm.auditor_id = atr.id
        <where>
            pm.id = #{ id }
        </where>
    </select>

    <select id="getFinMtrlCount" resultType="java.lang.Integer">
        SELECT count(DISTINCT pm.product_id) as fin_mtrl_count
        FROM prd_mo pm
        left join prd_mo_color_spec_data pmcsd on pm.id = pmcsd.pid
        <where>
            <if test="prdMo.no != null and prdMo.no != ''">
                and pm.no like concat('%', #{ prdMo.no }, '%')
            </if>
            <if test="prdMo.productId != null and prdMo.productId != ''">
                and pm.product_id = #{ prdMo.productId }
            </if>
            <if test="prdMo.productIds != null and prdMo.productIds.size > 0">
                and pm.product_id in
                <foreach collection="prdMo.productIds" item="productId" index="index"
                         open="(" separator="," close=")">
                    #{ productId }
                </foreach>
            </if>
            <if test="prdMo.followerId != null and prdMo.followerId != ''">
                and pm.follower_id = #{ prdMo.followerId }
            </if>
            <if test="prdMo.followerIds != null and prdMo.followerIds.size > 0">
                and pm.follower_id in
                <foreach collection="prdMo.followerIds" item="followerId" index="index"
                         open="(" separator="," close=")">
                    #{ followerId }
                </foreach>
            </if>
            <if test="prdMo.productionStatus != null">
                and pm.production_status = #{ prdMo.productionStatus }
            </if>
            <if test="prdMo.inProductionStatus != null and prdMo.inProductionStatus.size > 0">
                and pm.production_status in
                <foreach collection="prdMo.inProductionStatus" item="productionStatus" index="index"
                         open="(" separator="," close=")">
                    #{ productionStatus }
                </foreach>
            </if>
            <if test="prdMo.billType != null and prdMo.billType != ''">
                and pm.bill_type = #{ prdMo.billType }
            </if>
            <if test="prdMo.billTypes != null and prdMo.billTypes.size > 0">
                and pm.bill_type in
                <foreach collection="prdMo.billTypes" item="billType" index="index"
                         open="(" separator="," close=")">
                    #{ billType }
                </foreach>
            </if>
            <if test="prdMo.deliveryDateBegin != null and prdMo.deliveryDateBegin != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &gt;= #{ prdMo.deliveryDateBegin }
            </if>
            <if test="prdMo.deliveryDateEnd != null and prdMo.deliveryDateEnd != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &lt;= #{ prdMo.deliveryDateEnd }
            </if>
            <if test="prdMo.preBeginDateBegin != null and prdMo.preBeginDateBegin != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &gt;= #{ prdMo.preBeginDateBegin }
            </if>
            <if test="prdMo.preBeginDateEnd != null and prdMo.preBeginDateEnd != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &lt;= #{ prdMo.preBeginDateEnd }
            </if>
            <if test="prdMo.preEndDateBegin != null and prdMo.preEndDateBegin != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &gt;= #{ prdMo.preEndDateBegin }
            </if>
            <if test="prdMo.preEndDateEnd != null and prdMo.preEndDateEnd != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &lt;= #{ prdMo.preEndDateEnd }
            </if>
            <if test="prdMo.auditTimeBegin != null and prdMo.auditTimeBegin != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &gt;= #{ prdMo.auditTimeBegin }
            </if>
            <if test="prdMo.auditTimeEnd != null and prdMo.auditTimeEnd != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &lt;= #{ prdMo.auditTimeEnd }
            </if>
        </where>
    </select>

    <select id="getCount" resultType="java.lang.Integer">
        SELECT count(pm.id) as count
        FROM prd_mo pm
        <where>
            <if test="prdMo.no != null and prdMo.no != ''">
                and pm.no like concat('%', #{ prdMo.no }, '%')
            </if>
            <if test="prdMo.productId != null and prdMo.productId != ''">
                and pm.product_id = #{ prdMo.productId }
            </if>
            <if test="prdMo.productIds != null and prdMo.productIds.size > 0">
                and pm.product_id in
                <foreach collection="prdMo.productIds" item="productId" index="index"
                         open="(" separator="," close=")">
                    #{ productId }
                </foreach>
            </if>
            <if test="prdMo.followerId != null and prdMo.followerId != ''">
                and pm.follower_id = #{ prdMo.followerId }
            </if>
            <if test="prdMo.followerIds != null and prdMo.followerIds.size > 0">
                and pm.follower_id in
                <foreach collection="prdMo.followerIds" item="followerId" index="index"
                         open="(" separator="," close=")">
                    #{ followerId }
                </foreach>
            </if>
            <if test="prdMo.productionStatus != null">
                and pm.production_status = #{ prdMo.productionStatus }
            </if>
            <if test="prdMo.inProductionStatus != null and prdMo.inProductionStatus.size > 0">
                and pm.production_status in
                <foreach collection="prdMo.inProductionStatus" item="productionStatus" index="index"
                         open="(" separator="," close=")">
                    #{ productionStatus }
                </foreach>
            </if>
            <if test="prdMo.billType != null and prdMo.billType != ''">
                and pm.bill_type = #{ prdMo.billType }
            </if>
            <if test="prdMo.billTypes != null and prdMo.billTypes.size > 0">
                and pm.bill_type in
                <foreach collection="prdMo.billTypes" item="billType" index="index"
                         open="(" separator="," close=")">
                    #{ billType }
                </foreach>
            </if>
            <if test="prdMo.deliveryDateBegin != null and prdMo.deliveryDateBegin != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &gt;= #{ prdMo.deliveryDateBegin }
            </if>
            <if test="prdMo.deliveryDateEnd != null and prdMo.deliveryDateEnd != ''">
                and date_format(pm.delivery_date, '%Y-%m-%d') &lt;= #{ prdMo.deliveryDateEnd }
            </if>
            <if test="prdMo.preBeginDateBegin != null and prdMo.preBeginDateBegin != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &gt;= #{ prdMo.preBeginDateBegin }
            </if>
            <if test="prdMo.preBeginDateEnd != null and prdMo.preBeginDateEnd != ''">
                and date_format(pm.pre_begin_date, '%Y-%m-%d') &lt;= #{ prdMo.preBeginDateEnd }
            </if>
            <if test="prdMo.preEndDateBegin != null and prdMo.preEndDateBegin != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &gt;= #{ prdMo.preEndDateBegin }
            </if>
            <if test="prdMo.preEndDateEnd != null and prdMo.preEndDateEnd != ''">
                and date_format(pm.pre_end_date, '%Y-%m-%d') &lt;= #{ prdMo.preEndDateEnd }
            </if>
            <if test="prdMo.auditTimeBegin != null and prdMo.auditTimeBegin != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &gt;= #{ prdMo.auditTimeBegin }
            </if>
            <if test="prdMo.auditTimeEnd != null and prdMo.auditTimeEnd != ''">
                and date_format(pm.audit_time, '%Y-%m-%d') &lt;= #{ prdMo.auditTimeEnd }
            </if>
        </where>
    </select>

    <select id="getPrdMoDTO" resultType="com.fenglei.model.prd.dto.PrdMoDTO">
        SELECT
            a.NO,
            a.bill_type,
            a.delivery_date,
            bm.NAME productName,
            bm.number productNumber,
            suf.nickname follower,
            sul.nickname leader,
            a.pre_begin_date,
            a.pre_end_date,
            a.tags,
            pmd.color,
            pmd.specification,
            pmd.qty,
            bp.`name` produceName,
            pmma.id auxId,
            pmma.theory_qty auxQty,
            pmmd.id detailId,
            pmmd.theory_qty detailQty
        FROM
            prd_mo a
                LEFT JOIN bd_material bm ON bm.id = a.product_id
                LEFT JOIN sys_user suf ON a.follower_id = suf.id
                LEFT JOIN sys_user sul ON a.leader_id = sul.id
                LEFT JOIN prd_mo_color_spec_data pmd ON pmd.pid = a.id
                LEFT JOIN prd_mo_process pmp ON pmp.pid = a.id
                LEFT JOIN bd_procedure bp ON bp.id = pmp.procedure_id
                LEFT JOIN prd_mo_material_aux pmma ON pmma.pid = a.id
                LEFT JOIN prd_mo_material_detail pmmd ON pmma.pid = a.id
    </select>
</mapper>
