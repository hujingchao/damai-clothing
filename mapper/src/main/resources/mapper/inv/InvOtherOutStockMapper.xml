<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fenglei.mapper.inv.InvOtherOutStockMapper">


    <resultMap id="OtherOutStockMap" type="com.fenglei.model.inv.entity.InvOtherOutStock">
        <collection property="itemList" select="selectItem" column="{pid=id}"
                    javaType="java.util.ArrayList" ofType="com.fenglei.model.inv.entity.InvOtherOutStockItem">
        </collection>
    </resultMap>

    <select id="selectOutStock" resultMap="OtherOutStockMap">
        select ioos.* ,su1.nickname as stockerName,su2.nickname as creator,su3.nickname as updater,su4.nickname as auditor
        from inv_other_out_stock ioos
        left join sys_user su1 on su1.id = ioos.stocker_id
        left join sys_user su2 on su2.id = ioos.creator_id
        left join sys_user su3 on su3.id = ioos.updater_id
        left join sys_user su4 on su4.id = ioos.auditor_id
        <where>
            <if test="outStock.no != null and outStock.no.trim() != ''.toString()">
                ioos.no like concat('%',#{outStock.no},'%')
            </if>
            <if test="outStock.billStatus != null ">
                ioos.bill_status =#{outStock.no}
            </if>
            <if test="outStock.stockerId != null and outStock.stockerId.trim() != ''.toString()">
                ioos.stocker_id like concat('%',#{outStock.stockerId},'%')
            </if>

            <if test="outStock.stockerIdList != null and outStock.stockerIdList.size > 0">
                and ioos.stocker_id in
                <foreach collection="outStock.stockerIdList" item="stockerId" index="index"
                         open="(" separator="," close=")">
                    #{stockerId}
                </foreach>
            </if>
            <if test="outStock.inbillStatusList != null and outStock.inbillStatusList.size > 0">
                and ioos.bill_status in
                <foreach collection="outStock.inbillStatusList" item="billStatus" index="index"
                         open="(" separator="," close=")">
                    #{billStatus}
                </foreach>
            </if>
        </where>


    </select>

    <select id="selectItem" resultType="com.fenglei.model.inv.entity.InvOtherOutStockItem">
        select ioosi.*,bm.id as material_id,inv.material_detail_id,bm.number as material_number, bm.name as material_name, bm.material_group
                      , bm.unit_id, bu.name as unit_name
                      , bm.main_pic_id as main_pic_id, sf.url as main_pic_url
                      , bmd.color_id, bmc.color, bmd.specification_id, bms.specification
                      , rpsy.name as repository_name, posi.name as position_name
        from inv_other_out_stock_item ioosi
                       left join inv_inventory inv on ioosi.inv_id = inv.id
                       LEFT JOIN bd_material_detail bmd ON inv.material_detail_id = bmd.id
                       LEFT JOIN bd_material_color bmc ON bmd.color_id = bmc.id
                       LEFT JOIN bd_material_specification bms ON bmd.specification_id = bms.id
                       LEFT JOIN bd_material bm ON bmd.pid = bm.id
                       LEFT JOIN sys_files sf on bm.main_pic_id = sf.id
                       LEFT JOIN bd_unit bu ON bm.unit_id = bu.id
                       LEFT JOIN bd_repository rpsy ON inv.repository_id = rpsy.id
                       LEFT JOIN bd_position posi ON inv.position_id = posi.id
        where ioosi.pid = #{pid}
    </select>
    <select id="detailOutStock"  resultMap="OtherOutStockMap">
        select ioos.* ,su1.nickname as stockerName,su2.nickname as creator,su3.nickname as updater,su4.nickname as auditor
        from inv_other_out_stock ioos
                 left join sys_user su1 on su1.id = ioos.stocker_id
                 left join sys_user su2 on su2.id = ioos.creator_id
                 left join sys_user su3 on su3.id = ioos.updater_id
                 left join sys_user su4 on su4.id = ioos.auditor_id
        where ioos.id = #{id}

    </select>
</mapper>
